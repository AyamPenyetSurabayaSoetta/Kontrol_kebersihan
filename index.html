<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Kontrol Kebersihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container {
            max-height: 80vh;
            overflow: auto;
        }
        th, td {
            border: 1px solid #e5e7eb;
            text-align: center;
            padding: 0;
            position: relative;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: white;
            min-width: 200px;
            text-align: left;
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f9fafb;
        }
        .status-cell {
            width: 80px;
            height: 60px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .status-unchecked { background-color: #fee2e2; } /* Red */
        .status-checked { background-color: #dcfce7; } /* Green */
        .status-na { background-color: #f3f4f6; cursor: not-allowed; } /* Gray */
        .person-input {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            width: calc(100% - 4px);
            border: 1px solid #9ca3af;
            border-radius: 4px;
            font-size: 10px;
            padding: 1px 2px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Absensi Kebersihan</h1>
                <p class="text-md text-gray-600">Tampilan Bulanan</p>
            </div>
            <div class="flex items-center gap-2 mt-4 sm:mt-0">
                <button id="prev-month" class="p-2 rounded-md hover:bg-gray-200"><</button>
                <h2 id="month-year" class="text-xl font-semibold w-48 text-center"></h2>
                <button id="next-month" class="p-2 rounded-md hover:bg-gray-200">></button>
            </div>
        </header>

        <div id="loading-indicator" class="text-center p-8 bg-white rounded-lg shadow">
            <p>Memuat data...</p>
        </div>

        <div id="table-container" class="table-container hidden bg-white rounded-lg shadow">
            <table class="min-w-full border-collapse">
                <thead id="table-header"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- PENTING: GANTI DENGAN URL WEB APP ANDA ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzC5t2GD4O05lu25QaADRscjl_lQ_SXqkwpZAcuf9y4M0SbRIwFJmFa8r2Sx4PavKjLAg/exec';

        const tasks = [
            { id: 1, name: "Sapu & pel lantai area atas" }, { id: 2, name: "Sapu & pel lantai area bawah" }, { id: 3, name: "Kebersihan pagar tralis atas" }, { id: 4, name: "Kebersihan pagar tralis bawah" }, { id: 5, name: "Cuci halaman" }, { id: 6, name: "Kebersihan area bak sampah" }, { id: 7, name: "Kebersihan wastafel dan sekitarnya" }, { id: 8, name: "Kebersihan kursi bayi" }, { id: 9, name: "Kebersihan kotak tisu" }, { id: 10, name: "Pengisian kecap, tisu, dan tusuk gigi" }, { id: 11, name: "Kebersihan Area kasir" }, { id: 12, name: "Kebersihan tempat dus nasi kotak" }, { id: 13, name: "Kebersihan & kerapian mushola" }, { id: 14, name: "Pengecekan & kebersihan toilet customer" }, { id: 15, name: "Kebersihan area playground" }, { id: 16, name: "Kebersihan Ember & tempat sampah stainless" }, { id: 17, name: "Kebersihan tong sampah" }, { id: 18, name: "Kebersihan tangga (setiap minggu pertama)", frequency: "mingguan" }, { id: 19, name: "Membuang dan mengganti kresek sampah WC & mushola" },
        ];

        let viewDate = new Date();
        let monthlyData = {};
        let saveTimeout;

        const el = {
            monthYear: document.getElementById('month-year'),
            tableHeader: document.getElementById('table-header'),
            tableBody: document.getElementById('table-body'),
            loading: document.getElementById('loading-indicator'),
            container: document.getElementById('table-container'),
            prevMonthBtn: document.getElementById('prev-month'),
            nextMonthBtn: document.getElementById('next-month'),
        };

        function getMonthKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        async function loadDataForMonth() {
            el.container.classList.add('hidden');
            el.loading.classList.remove('hidden');

            if (SCRIPT_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
                el.loading.innerHTML = `<p class="text-red-500">Error: URL Google Apps Script belum dimasukkan.</p>`;
                return;
            }

            const monthKey = getMonthKey(viewDate);
            try {
                const response = await fetch(`${SCRIPT_URL}?month=${monthKey}&v=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                monthlyData = data || {};
                renderTable();
            } catch (error) {
                console.error("Gagal memuat data:", error);
                el.loading.innerHTML = `<p class="text-red-500">Gagal memuat data. Periksa koneksi dan pengaturan script.</p>`;
            } finally {
                el.loading.classList.add('hidden');
                el.container.classList.remove('hidden');
            }
        }

        function renderTable() {
            el.monthYear.textContent = viewDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Render Header
            let headerHTML = '<tr><th class="p-2">Kegiatan</th>';
            for (let day = 1; day <= daysInMonth; day++) {
                headerHTML += `<th class="p-2">${day}</th>`;
            }
            headerHTML += '</tr>';
            el.tableHeader.innerHTML = headerHTML;

            // Render Body
            let bodyHTML = '';
            tasks.forEach(task => {
                bodyHTML += `<tr><td class="p-2 font-medium">${task.name}</td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const taskData = monthlyData[dateKey]?.[task.id] || {};
                    const isChecked = taskData.status === 'checked';
                    
                    let cellClass = isChecked ? 'status-checked' : 'status-unchecked';
                    let content = isChecked ? 'âœ“' : '';
                    
                    let isNA = task.frequency === 'mingguan' && day > 7;
                    if (isNA) {
                        cellClass = 'status-na';
                        content = '';
                    }

                    bodyHTML += `<td class="status-cell ${cellClass}" data-date="${dateKey}" data-task-id="${task.id}">
                        <span class="text-2xl font-bold">${content}</span>
                        ${isChecked ? `<input type="text" class="person-input" placeholder="Petugas..." value="${taskData.person || ''}">` : ''}
                    </td>`;
                }
                bodyHTML += '</tr>';
            });
            el.tableBody.innerHTML = bodyHTML;
        }

        function saveData() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const monthKey = getMonthKey(viewDate);
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ month: monthKey, data: monthlyData })
                }).catch(error => console.error('Gagal menyimpan:', error));
            }, 1500); // Tunggu 1.5 detik untuk menyimpan
        }

        el.tableBody.addEventListener('click', (e) => {
            const cell = e.target.closest('.status-cell');
            if (cell && !cell.classList.contains('status-na')) {
                const dateKey = cell.dataset.date;
                const taskId = cell.dataset.taskId;

                // Inisialisasi data jika belum ada
                if (!monthlyData[dateKey]) monthlyData[dateKey] = {};
                if (!monthlyData[dateKey][taskId]) monthlyData[dateKey][taskId] = {};
                
                const currentStatus = monthlyData[dateKey][taskId].status;
                const newStatus = currentStatus === 'checked' ? 'unchecked' : 'checked';
                monthlyData[dateKey][taskId].status = newStatus;

                if (newStatus === 'unchecked') {
                    monthlyData[dateKey][taskId].person = '';
                }
                
                renderTable(); // Render ulang seluruh tabel untuk memperbarui tampilan
                saveData();
            }
        });

        el.tableBody.addEventListener('input', (e) => {
            if (e.target.classList.contains('person-input')) {
                const cell = e.target.closest('.status-cell');
                const dateKey = cell.dataset.date;
                const taskId = cell.dataset.taskId;
                monthlyData[dateKey][taskId].person = e.target.value;
                saveData();
            }
        });

        el.prevMonthBtn.addEventListener('click', () => {
            viewDate.setMonth(viewDate.getMonth() - 1);
            loadDataForMonth();
        });

        el.nextMonthBtn.addEventListener('click', () => {
            viewDate.setMonth(viewDate.getMonth() + 1);
            loadDataForMonth();
        });

        loadDataForMonth();
    });
    </script>
</body>
</html>
